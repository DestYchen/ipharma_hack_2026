# Pharma MVP — Reference + Router + Synopsis

Краткий проект для локального поиска референтных препаратов в XLS и запуска LLM‑пайплайна для анализа и генерации синопсиса в Word.

## Что делает проект
1. **Поиск референта** по МНН/пути введения/форме/типу высвобождения/дозировке в XLS‑файле (лист ст27.1 ФЗ‑61).
2. **Выбор референта** и запуск анализа через `test_router.py` (LLM с web search).
3. **Генерация синопсиса** по результатам в `.docx` через `synopsis_service.py`.
4. **UI** — локальный фронтенд (chat‑формат) для ввода данных, выбора и просмотра результатов.

## Архитектура (ключевые части)
- `pharma_local_api.py`  
  Локальный HTTP API + отдача UI.  
  Методы:
  - `POST /reference/search` — поиск совпадений в XLS
  - `POST /reference/choose` — выбор референта
  - `POST /pipeline/analyze` — выбор + запуск анализа
  - `POST /router/analyze` — прямой запуск анализа по референту
  - `POST /synopsis/build` — генерация синопсиса (docx)
  - `GET /runs/list`, `GET /runs/get` — история
  - `GET /synopsis/get` — статус синопсиса
- `find_reference_drug.py`  
  Чтение XLS и фильтрация совпадений.
- `test_router.py`  
  LLM‑скрипт: собирает данные по препарату из открытых источников и возвращает Markdown‑таблицу + JSON.
- `synopsis_service.py`  
  Берёт `run_id` из SQLite, собирает атрибуты, вызывает LLM и собирает Word по шаблону.
- `frontend/`  
  Статичный UI (HTML/CSS/JS), который работает с API.
- `pharma_runs.db`  
  SQLite‑база с историями запусков и синопсисами.

## Что делает каждый модуль
### `pharma_local_api.py`
Главный локальный сервер: HTTP API + раздача фронтенда.  
Сценарии:
- принимает параметры поиска, читает XLS, находит совпадения;
- сохраняет сессию поиска и варианты референта;
- выбирает референт, сохраняет run в SQLite;
- запускает `test_router.py` через адаптер;
- хранит и отдает историю (`runs`) и синопсисы (`synopsis_runs`);
- отдает статические файлы UI и сгенерированные `.docx`.

### `find_reference_drug.py`
Ядро поиска по XLS:
- читает лист `ст27.1 ФЗ-61`;
- нормализует пути введения, формы, дозировки, тип высвобождения;
- фильтрует строки и собирает варианты референтов;
- формирует итоговый payload с выбранным референтом и строками.

### `test_router.py`
LLM‑скрипт, который:
- принимает название препарата;
- формирует промпт;
- запрашивает OpenRouter (модель с web search);
- возвращает Markdown‑таблицу и JSON со ссылками/источниками.

### `test_router_adapter.py`
Адаптер к `test_router.py`:
- загружает файл как модуль;
- вызывает функцию общения с LLM;
- возвращает текст ответа в API.

### `synopsis_service.py`
Сервис генерации синопсиса:
- берет `run_id` из SQLite;
- собирает атрибуты (query, референт, строки, ответ LLM);
- подставляет в промпт + шаблон;
- запрашивает LLM;
- конвертирует Markdown‑таблицу в `.docx`.

### `pharma_api_client.py`
CLI‑клиент для API:
- интерактивно отправляет запросы к локальному API;
- полезен для тестирования без UI.

### `frontend/`
UI (чат‑формат):
- ввод параметров, выбор референта;
- отображение таблиц;
- запуск синопсиса и скачивание `.docx`;
- история запусков.

## Быстрый старт (локально)
1. Установи зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Запусти API:
   ```bash
   python pharma_local_api.py --host 127.0.0.1 --port 8000
   ```
3. Открой UI:
   ```
   http://127.0.0.1:8000
   ```

## Требуемые зависимости
См. `requirements.txt` (минимальный набор):
- `pandas`
- `xlrd`
- `requests`
- `python-docx`

## Входные данные
- XLS‑файл с перечнем (по умолчанию ищется первый `.xls` в папке).
- Лист: `ст27.1 ФЗ-61`.

## Синопсис
Шаблон: `Синопсис для гпт ver.2 (3).docx`  
Промпт: `промт для синопсиса.txt`

## Переменные окружения
LLM‑вызовы используют OpenRouter:
- `OPENROUTER_API_KEY` — ключ (для `test_router.py`)
- `PHARMA_API_KEY` — ключ (для `synopsis_service.py`)
- `OPENROUTER_MODEL` — модель
- `OPENROUTER_REFERER`, `OPENROUTER_TITLE` — опционально

Примечание: в `test_router.py` сейчас может быть прописан ключ напрямую — лучше заменить на env var.

## Где что хранится
- История запусков: `pharma_runs.db`
- Результаты синопсиса: `downloads/`

## Типичный сценарий
1. В UI вводишь поля поиска.
2. Получаешь варианты референтов.
3. Выбираешь вариант → запускается `test_router.py`.
4. Появляется таблица данных.
5. Нажимаешь «Создать синопсис» → скачиваешь Word.

## Лицензия / дисклеймер
Это MVP. Данные извлекаются из открытых источников и зависят от доступности и качества источников.
